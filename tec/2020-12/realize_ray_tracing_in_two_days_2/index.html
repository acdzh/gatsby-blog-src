<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link href="https://cdn.bootcdn.net/ajax/libs/firacode/5.2.0/fira_code.min.css" rel="stylesheet"/><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.2/css/all.min.css" rel="stylesheet"/><style data-href="/styles.6fd271361286800aedde.css" id="gatsby-global-css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline}code,kbd,samp{font-family:monospace,monospace;font-size:1em}img{border-style:none}button,input{overflow:visible}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]::-webkit-search-decoration{-webkit-appearance:none}details{display:block}[hidden]{display:none}


/*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */:root{-moz-tab-size:4;-o-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input:-ms-input-placeholder,textarea:-ms-input-placeholder{color:#9ca3af}input::placeholder,textarea::placeholder{color:#9ca3af}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block}img,video{max-width:100%;height:auto}*{outline:none}:active,:focus,[role=button]::-moz-focus-inner,button::-moz-focus-inner,input::-moz-focus-inner{outline:none}button.active.focus,button.active:focus,button.focus,button:active.focus,button:active:focus,button:focus{outline:none}:root{--Primary:#308080;--TextTitle:#444;--TextPrimary:#666;--TextQuote:#777;--TextOnBg:hsla(0,0%,100%,0.8);--BgHeader:#308080;--BgPrimary:#fff;--BgBody:#eaeaea;--BgSideBar:#f0f0f0;--BgSideBarHover:#ebebeb;--BgTags:#f2f2f2;--BgCode:#f4f4f4;--BgLicense:#fffeee;--LineSeparatorPrimary:#eee;--LineSeparatorSecondary:#ddd;--LineBorder:#d9d9d9;--LineTable:#f1f1f1}:root,[data-theme=dark]:root{--ConstTextSecondary:hsla(0,0%,100%,0.4);--ConstTextThird:#777;--ConstTextTag:#999;--TextThird:#aaa;--TextCode:var(--Primary);--BgSelect:rgba(0,128,128,0.3764705882352941);--BgFooter:#33363b}[data-theme=dark]:root{--Primary:#409090;--TextTitle:#bbb;--TextPrimary:#999;--TextQuote:#888;--TextOnBg:#bbb;--BgHeader:#33363b;--BgPrimary:#33363b;--BgBody:#292929;--BgSideBar:var(--BgPrimary);--BgSideBarHover:#383838;--BgTags:#2e2e2e;--BgCode:#3a3a3a;--BgLicense:#3e4147;--LineSeparatorPrimary:#555;--LineSeparatorSecondary:#444;--LineBorder:#666;--LineTable:#2d3235}::selection{background:var(--BgSelect)}::-moz-selection{background:var(--BgSelect)}::-webkit-selection{background:var(--BgSelect)}*{transition:background-color,border-color;transition-duration:.2s;transition-timing-function:ease}body{background-color:var(--BgBody);color:var(--TextPrimary);font-family:Helvetica Neue,Hiragino Sans GB,Microsoft YaHei,"\9ED1\4F53",Arial,sans-serif}a{transition-duration:.2s;transition-timing-function:ease}*{min-width:0}.hidden{display:none}[data-theme=light] body code[class*=language-],[data-theme=light] body pre[class*=language-]{color:#383a42;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}[data-theme=light] body code[class*=language-]::-moz-selection,[data-theme=light] body code[class*=language-] ::-moz-selection,[data-theme=light] body code[class*=language-]::selection,[data-theme=light] body code[class*=language-] ::selection,[data-theme=light] body pre[class*=language-]::-moz-selection,[data-theme=light] body pre[class*=language-] ::-moz-selection,[data-theme=light] body pre[class*=language-]::selection,[data-theme=light] body pre[class*=language-] ::selection{text-shadow:none;background:#e5e6e7}@media print{[data-theme=light] body code[class*=language-],[data-theme=light] body pre[class*=language-]{text-shadow:none}}[data-theme=light] body pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}[data-theme=light] body :not(pre)>code[class*=language-],[data-theme=light] body pre[class*=language-]{background:#fff;border:1px solid #e7eaf4}[data-theme=light] body :not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}[data-theme=light] body .token.cdata,[data-theme=light] body .token.comment,[data-theme=light] body .token.doctype,[data-theme=light] body .token.prolog{color:#a0a1a7}[data-theme=light] body .token.punctuation{color:#383a42}[data-theme=light] body .token.selector,[data-theme=light] body .token.tag{color:#f07c85}[data-theme=light] body .token.attr-name,[data-theme=light] body .token.boolean,[data-theme=light] body .token.constant,[data-theme=light] body .token.deleted,[data-theme=light] body .token.number,[data-theme=light] body .token.property,[data-theme=light] body .token.symbol{color:#e1aa76}[data-theme=light] body .token.attr-value,[data-theme=light] body .token.builtin,[data-theme=light] body .token.char,[data-theme=light] body .token.inserted,[data-theme=light] body .token.string{color:#88b369}[data-theme=light] body .language-css .token.string,[data-theme=light] body .style .token.string,[data-theme=light] body .token.entity,[data-theme=light] body .token.operator,[data-theme=light] body .token.url{color:#46a6b2}[data-theme=light] body .token.function{color:#519fdf}[data-theme=light] body .token.atrule,[data-theme=light] body .token.important,[data-theme=light] body .token.keyword,[data-theme=light] body .token.regex,[data-theme=light] body .token.variable{color:#b668cd}[data-theme=light] body .token.bold,[data-theme=light] body .token.important{font-weight:700}[data-theme=light] body .token.italic{font-style:italic}[data-theme=light] body .token.entity{cursor:help}[data-theme=light] body pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}[data-theme=light] body pre.line-numbers>code{position:relative}[data-theme=light] body .line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:0;-webkit-user-select:none;-ms-user-select:none;user-select:none}[data-theme=light] body .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}[data-theme=light] body .line-numbers-rows>span:before{content:counter(linenumber);color:#b5b9c2;display:block;padding-right:.8em;text-align:right}[data-theme=light] body code.language-css,[data-theme=light] body code.language-javascript,[data-theme=light] body code.language-js,[data-theme=light] body code.language-jsx,[data-theme=light] body code.language-sass,[data-theme=light] body code.language-scss,[data-theme=light] body code.language-ts,[data-theme=light] body code.language-tsx,[data-theme=light] body code.language-typescript,[data-theme=light] body pre.languagecss,[data-theme=light] body pre.languagejavascript,[data-theme=light] body pre.languagejs,[data-theme=light] body pre.languagejsx,[data-theme=light] body pre.languagesass,[data-theme=light] body pre.languagescss,[data-theme=light] body pre.languagets,[data-theme=light] body pre.languagetsx,[data-theme=light] body pre.languagetypescript{color:#ca1243}[data-theme=dark] body code[class*=language-],[data-theme=dark] body pre[class*=language-]{color:#abb2bf;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}[data-theme=dark] body code[class*=language-]::-moz-selection,[data-theme=dark] body code[class*=language-] ::-moz-selection,[data-theme=dark] body code[class*=language-]::selection,[data-theme=dark] body code[class*=language-] ::selection,[data-theme=dark] body pre[class*=language-]::-moz-selection,[data-theme=dark] body pre[class*=language-] ::-moz-selection,[data-theme=dark] body pre[class*=language-]::selection,[data-theme=dark] body pre[class*=language-] ::selection{text-shadow:none;background:#9aa2b1}@media print{[data-theme=dark] body code[class*=language-],[data-theme=dark] body pre[class*=language-]{text-shadow:none}}[data-theme=dark] body pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}[data-theme=dark] body :not(pre)>code[class*=language-],[data-theme=dark] body pre[class*=language-]{background:#282c34;border:1px solid transparent}[data-theme=dark] body :not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}[data-theme=dark] body .token.cdata,[data-theme=dark] body .token.comment,[data-theme=dark] body .token.doctype,[data-theme=dark] body .token.prolog{color:#5c6370}[data-theme=dark] body .token.punctuation{color:#abb2bf}[data-theme=dark] body .token.selector,[data-theme=dark] body .token.tag{color:#e06c75}[data-theme=dark] body .token.attr-name,[data-theme=dark] body .token.boolean,[data-theme=dark] body .token.constant,[data-theme=dark] body .token.deleted,[data-theme=dark] body .token.number,[data-theme=dark] body .token.property,[data-theme=dark] body .token.symbol{color:#d19a66}[data-theme=dark] body .token.attr-value,[data-theme=dark] body .token.builtin,[data-theme=dark] body .token.char,[data-theme=dark] body .token.inserted,[data-theme=dark] body .token.string{color:#98c379}[data-theme=dark] body .language-css .token.string,[data-theme=dark] body .style .token.string,[data-theme=dark] body .token.entity,[data-theme=dark] body .token.operator,[data-theme=dark] body .token.url{color:#56b6c2}[data-theme=dark] body .token.function{color:#61afef}[data-theme=dark] body .token.atrule,[data-theme=dark] body .token.important,[data-theme=dark] body .token.keyword,[data-theme=dark] body .token.regex,[data-theme=dark] body .token.variable{color:#c678dd}[data-theme=dark] body .token.bold,[data-theme=dark] body .token.important{font-weight:700}[data-theme=dark] body .token.italic{font-style:italic}[data-theme=dark] body .token.entity{cursor:help}[data-theme=dark] body pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}[data-theme=dark] body pre.line-numbers>code{position:relative}[data-theme=dark] body .line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:0;-webkit-user-select:none;-ms-user-select:none;user-select:none}[data-theme=dark] body .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}[data-theme=dark] body .line-numbers-rows>span:before{content:counter(linenumber);color:#5c6370;display:block;padding-right:.8em;text-align:right}[data-theme=dark] body code.language-css,[data-theme=dark] body code.language-javascript,[data-theme=dark] body code.language-js,[data-theme=dark] body code.language-jsx,[data-theme=dark] body code.language-sass,[data-theme=dark] body code.language-scss,[data-theme=dark] body code.language-ts,[data-theme=dark] body code.language-tsx,[data-theme=dark] body code.language-typescript,[data-theme=dark] body pre.languagecss,[data-theme=dark] body pre.languagejavascript,[data-theme=dark] body pre.languagejs,[data-theme=dark] body pre.languagejsx,[data-theme=dark] body pre.languagesass,[data-theme=dark] body pre.languagescss,[data-theme=dark] body pre.languagets,[data-theme=dark] body pre.languagetsx,[data-theme=dark] body pre.languagetypescript{color:#fa4273}.responsive-iframe-container{margin:1em auto;overflow:hidden;padding-top:56.25%;position:relative}.responsive-iframe-container>iframe{border:0;height:100%;left:0;position:absolute;top:0;width:100%}.button{min-width:64px;font-size:14px;font-weight:500;line-height:1.75;border-radius:4px;letter-spacing:.02857em;transition-duration:.2s;transition-timing-function:ease}.button:hover{transform:scale(1.02)}.button:hover .button__container{background-color:rgba(0,0,0,.1)}.button--primary{box-shadow:0 1px 5px rgba(0,0,0,.075),0 1px 5px rgba(0,0,0,.1);background-color:var(--Primary);color:var(--TextOnBg)}.button--outline{border:1px solid var(--LineBorder);color:var(--TextPrimary)}.button--outline:hover{color:var(--Primary)}.button__container{padding:5px 15px}.input{background-color:var(--BgPrimry);font-size:14px;padding:0 10px;height:36px;border-radius:4px;border:1px solid var(--LineBorder)}.nav{position:fixed;top:0;left:0;right:0;width:100%;height:50px;z-index:1000;border-radius:0 0 6px 6px;box-shadow:0 1px 5px rgba(0,0,0,.075),0 1px 5px rgba(0,0,0,.1);background-color:var(--BgHeader)}.nav-inner{width:100%;height:100%;max-width:1380px;position:relative;margin:0 auto}.nav-menu{display:flex;flex-direction:row}.nav-menu-left{float:left}.nav-menu-right{float:right}.nav-menu-item{line-height:20px;font-weight:600;border-radius:6px}.nav-menu-item-obj{padding:15px 20px;color:var(--TextOnBg)}.nav-menu-item-button{font-size:20px;width:50px;height:50px;color:var(--TextOnBg)}.nav-menu-item-button:hover,.nav-menu-item-obj:hover{background-color:rgba(0,0,0,.1);color:#fff}.nav-menu-item-text{padding:15px 20px;color:var(--ConstTextSecondary)}.nav-menu-item-bar{display:none}@media only screen and (max-width:900px){.nav-menu-item-bar{display:block}.nav-menu-item-obj,.nav-menu-item-text{display:none}}.nav-expand-menu{position:fixed;top:40px;left:0;right:0;width:100%;z-index:900;padding:10px 20px;border-radius:6px;box-shadow:0 2px 3px rgba(26,26,26,.46);background-color:var(--BgHeader)}@media only screen and (min-width:900px){.nav-expand-menu{display:none}}.nav-expand-menu-item{padding:10px 0}.nav-expand-menu-item-obj{color:var(--TextOnBg)}.nav-expand-menu-item-text{color:var(--ConstTextSecondary)}:target{padding-top:80px;margin-top:-80px}.card-container{border-radius:8px;overflow:hidden;box-shadow:0 1px 5px rgba(0,0,0,.075),0 1px 5px rgba(0,0,0,.1)}.card-container-top{position:relative;height:60px;padding:18px 30px;font-size:16px;font-weight:600;text-transform:uppercase;line-height:24px;border-radius:8px 8px 0 0;white-space:nowrap;overflow:hidden;border-bottom:1px solid var(--LineSeparatorPrimary)}.folded .card-container-top{border-radius:8px}.card-container-top__const li{display:inline-block;margin-right:14px}.card-container-top__const li:hover{color:var(--Primary)}.card-container-top__const{color:var(--TextThird)}.card-container-top__primary{background-color:var(--BgHeader);color:var(--TextOnBg)}.card-container-top-fold-button{display:inline-flex;position:absolute;top:0;bottom:0;height:24px;margin:auto;right:20px;align-items:center;justify-content:center}.folded .card-content{display:none}.card-content a:hover{color:var(--Primary)}.sidebar-content-separator{width:100%;height:1px;background-color:var(--LineSeparatorSecondary)}.sidebar-content-separator:last-child{display:none}.sidebar-content-post-toc{max-height:460px;overflow-y:auto;margin:0;padding:20px 30px;font-size:14px;line-height:2em}.sidebar-content-post-toc li,.sidebar-content-post-toc ul{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.sidebar-content-post-toc ul ul{margin-left:10px}.sidebar-content-post-toc ul ul ul{margin-left:20px}.sidebar-content-post-toc ul ul ul ul{margin-left:30px}.sidebar-content-post-toc a:hover{color:var(--Primary)}.sidebar-content-post-nav-item{width:100%;min-height:106px;position:relative;display:flex;text-align:center;align-items:center;justify-content:center;padding:16px 40px 24px;transition-duration:.3s;transition-timing-function:ease-out}.sidebar-content-post-nav-item:hover{background-color:var(--BgSideBarHover)}.sidebar-content-post-nav-item *{transition-duration:.3s;transition-timing-function:ease-out}.sidebar-content-post-nav-item i{color:var(--TextThird);font-size:16px;position:absolute;margin:auto}.sidebar-content-post-nav-prev i{left:20px}.sidebar-content-post-nav-next i{right:20px}.sidebar-content-post-nav-item:hover i{color:var(--Primary);transform:scale(1.2)}.sidebar-content-post-nav-item strong{display:block;font-size:12px;color:var(--TextThird);letter-spacing:.5px;font-weight:400;text-transform:uppercase}.sidebar-content-post-nav-item span{font-size:14px;color:var(--TextPrimary)}.sidebar-content-post-nav-item:hover span{color:var(--Primary)}.post{margin-bottom:40px;overflow:hidden}.post a{color:var(--Primary)}.post-container{padding:20px 30px}@media only screen and (max-width:812px){.post-container{padding:20px 10px}}.post-title{font-size:38px;letter-spacing:-1px;line-height:1.3em;color:var(--TextTitle);margin-bottom:10px;font-weight:400}@media only screen and (max-width:812px){.post-title{font-size:22px}}.post-meta{font-size:14px;font-weight:400;color:var(--TextThird);text-transform:uppercase;margin-bottom:1em}.post-entry-license{border:1px dashed var(--LineSeparatorPrimary);padding:10px;background-color:var(--BgLicense);background-repeat:no-repeat;background-attachment:scroll;background-position:1% 50%;border-radius:6px}.post-entry{font-size:16px;line-height:1.8em}.post-entry dd,.post-entry hr,.post-entry p{margin-bottom:1em}.post-entry dt{color:var(--TextTitle)}.post-entry ol,.post-entry ul{margin:0 0 15px 30px}.post-entry ol ol,.post-entry ol ul,.post-entry ul ol,.post-entry ul ul{margin-bottom:0}.post-entry li{margin-top:.1em}.post-entry ol ul li,.post-entry ul li{list-style:square}.post-entry ol li,.post-entry ol ul ol li{list-style:decimal}.post-entry dt{font-weight:600}.post-entry address{margin-bottom:1em}.post-entry blockquote{position:relative;color:var(--TextQuote);margin:0 0 20px;padding-left:10px;border-left:3px solid var(--LineBorder)}.post-entry blockquote p{margin-bottom:.75em}.post-entry code,.post-entry pre{font-family:Fira Code,monospace;font-size:14px}@supports(font-variation-settings:normal){.post-entry code,.post-entry pre{font-family:Fira Code VF,monospace}}.post-entry pre{width:100%;margin:10px 0 15px;border:1px solid var(--LineSeparatorSecondary);line-height:19px;white-space:pre;word-wrap:break-word;overflow-x:auto;overflow-y:hidden}.post-entry :not(pre)>code{padding:2px 4px;font-size:90%;color:var(--TextCode);background-color:var(--BgCode);border-radius:4px}.post-entry .line-numbers .line-numbers-rows{padding-top:1em;padding-bottom:1em;font-size:14px;line-height:1.5;padding-left:10px}.post-entry sub,.post-entry sup{font-size:62.5%}.post-entry sub{vertical-align:sub}.post-entry sup{vertical-align:super}.post-entry table{font-size:14px;margin-bottom:1.5em;width:100%;text-align:center}.post-entry table tbody tr:nth-child(odd){background:var(--LineTable)}.post-entry table td{padding:5px;vertical-align:middle}.post-entry table td,.post-entry table th{border-bottom:1px solid var(--LineTable);text-align:center}.post-entry table th{font-weight:600;border-top:1px solid var(--LineTable);padding:10px 5px}.post-entry h1,.post-entry h2,.post-entry h3,.post-entry h4,.post-entry h5,.post-entry h6{color:var(--TextTitle);font-weight:600;-ms-word-wrap:break-word;word-wrap:break-word}.post-entry h1 span,.post-entry h2 span,.post-entry h3 span,.post-entry h4 span,.post-entry h5 span,.post-entry h6 span{color:var(--TextPrimary)}.post-entry h1,.post-entry h2,.post-entry h3,.post-entry h4,.post-entry h5,.post-entry h6{margin-bottom:14px;font-weight:400;line-height:1.8em}.post-entry h1{font-size:38px;letter-spacing:-1px}.post-entry h2{font-size:34px;letter-spacing:-.7px}.post-entry h3{font-size:28px;letter-spacing:-.5px}.post-entry h4{font-size:24px;letter-spacing:-.3px}.post-entry h5{font-size:20px;font-weight:600}.post-entry h6{font-size:18px;font-weight:600;text-transform:uppercase}.post-entry img{text-align:center}@media only screen and (max-width:812px){.post-entry h1{font-size:30px;letter-spacing:-.7px}.post-entry h2{font-size:26px;letter-spacing:-.5px}.post-entry h3{font-size:24px;letter-spacing:-.3px}.post-entry h4{font-size:22px;letter-spacing:-.3px}.post-entry h5{font-size:18px;font-weight:600}.post-entry h6{font-size:16px;font-weight:600;text-transform:uppercase}}.post-entry strong{font-weight:600}.post-entry :not(pre)>code,.post-entry iframe,.post-entry img,.post-entry pre,.post-entry svg,.post-entry table{border-radius:6px;box-shadow:0 1px 5px rgba(0,0,0,.075);border:1px solid var(--LineSeparatorSecondary);overflow:hidden}.post-entry .math svg{border-radius:unset;box-shadow:unset;border:unset}.post-entry .gatsby-resp-image-background-image{border-radius:6px}.post-entry :not(.gatsby-resp-image-background-image)>img{position:relative;display:block;margin-left:auto;margin-right:auto;max-width:650px}.post-entry :not(pre)>code{margin:0 .1em;font-size:14px}.post-tags{margin-top:20px}.post-tags a{background:var(--BgTags);display:inline-block;line-height:16px;white-space:nowrap;font-size:12px;color:var(--ConstTextTag);padding:3px 7px;margin:0 5px 2px 0;border-radius:2px}.post-tags a:hover{color:var(--Primary);transform:scale(1.02);box-shadow:0 1px 5px rgba(0,0,0,.075)}.content-main-container{width:100%;flex:1 1;padding:0 20px 60px;margin-top:80px}@media only screen and (max-width:719px){.content-main-container{padding:0 10px 60px}}.content-main{width:100%;max-width:1380px;margin:0 auto}@media only screen and (min-width:1280px){.content-main-sidebar{flex-shrink:0;width:320px;margin-left:20px}}@media only screen and (min-width:719px) and (max-width:1280px){.content-main-sidebar{position:fixed;right:20px}}@media only screen and (max-width:719px){.content-main-sidebar{position:fixed;right:10px}}@media only screen and (max-width:1280px){.content-main-sidebar .card-container{width:320px}.content-main-sidebar .card-container.folded{width:64px}.content-main-sidebar .card-container.folded .card-container-top-fold-button{left:20px}.content-main-sidebar .card-container.folded .card-container-top-inner{display:none}}.footer{width:100%;position:relative;background-color:var(--BgFooter);border-radius:8px 8px 0 0;box-shadow:0 1px 5px rgba(0,0,0,.075)}.footer-back-topp{background:hsla(0,0%,100%,.7);color:var(--ConstTextThird);overflow:hidden;text-align:center;width:60px;height:30px;display:flex;margin:0 auto;border-radius:0 0 3px 3px;box-shadow:inset 0 1px 0 rgba(0,0,0,.05);justify-content:center;align-items:center;font-size:38px;font-weight:900}.footer-container{width:100%;max-width:1380px;position:relative;margin:0 auto;padding:0 30px 30px}.footer-container .footer-left-pad{font-size:1.1rem;line-height:1.5rem;color:hsla(0,0%,100%,.4)}.footer-container .footer-left-pad a,.footer-container .footer-right-pad{color:hsla(0,0%,100%,.7)}@media only screen and (min-width:719px){.footer-container{display:grid;grid-template-columns:1fr 1fr}.footer-container .footer-right-pad{text-align:right}}@media only screen and (max-width:719px){.footer-container{display:block}.footer-container .footer-left-pad,.footer-container .footer-right-pad{margin-top:10px;text-align:center}}.footer-sociall-links{font-size:1.5rem}.footer-sociall-links a{padding:0 4px}.featured{padding-bottom:30px;margin-bottom:30px;border-bottom:1px solid var(--LineSeparatorPrimary)}.featured-post-meta{text-transform:none;font-size:14px;font-weight:400;color:var(--TextThird);margin-bottom:.3em}.featured-post-title{margin-bottom:10px;color:var(--TextTitle);font-size:30px;font-weight:400;line-height:1.4em;letter-spacing:-.7px}@media only screen and (max-width:812px){.featured-post-title{font-size:22px}}.featured-post-body{display:flex}.featured-post-cover{margin-right:18px;flex-shrink:0;border-radius:6px;transition-duration:.3s;transition-timing-function:ease}.featured-post-body:hover .featured-post-cover{transform:scale(1.02);box-shadow:0 1px 5px rgba(0,0,0,.15)}@media only screen and (max-width:900px){.featured-post-body{display:block}.featured-post-cover{float:left}}.featured-post-content{font-size:16px;line-height:1.8em;word-break:break-all}.featured-post-content-read-more{color:var(--Primary);font-size:small}.featured-post-tags{margin-top:8px}.featured-post-tags a{background:var(--BgTags);display:inline-block;line-height:16px;white-space:nowrap;font-size:12px;color:var(--ConstTextTag);padding:3px 7px;margin-right:5px;border-radius:2px}.featured-post-tags a:hover{color:var(--Primary);transform:scale(1.02);box-shadow:0 1px 5px rgba(0,0,0,.075)}.simple-featured{border-bottom:1px solid var(--LineSeparatorPrimary);padding:10px 0;font-size:16px;font-weight:400;display:flex;flex-direction:row}.simple-featured-date{margin-right:20px;flex-shrink:0;color:var(--TextThird)}@media only screen and (max-width:812px){.simple-featured{flex-direction:column}.simple-featured-date{margin-right:0;margin-bottom:10px}}.pagination{margin:0;padding:0;list-style:none;font-size:14px}.pagination-item{min-width:32px;text-align:center;list-style:none;border:1px solid;border-radius:6px;outline:0;-webkit-user-select:none;-ms-user-select:none;user-select:none;display:inline-block;height:32px;margin-right:10px;line-height:30px;vertical-align:middle;transition-duration:.2s;transition-timing-function:ease}.pagination-item-enabled{cursor:pointer;border-color:var(--LineBorder)}.pagination-item-active,.pagination-item-enabled:hover{border-color:var(--Primary);color:var(--Primary);box-shadow:0 1px 5px rgba(0,0,0,.075)}.pagination-item-disabled{cursor:not-allowed;color:var(--TextThird);border-color:var(--TextThird)}.pagination-item a{display:block;padding:0 6px}</style><meta name="generator" content="Gatsby 2.32.3"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=ffb2f5920276563941e386260c477317" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#008080"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=ffb2f5920276563941e386260c477317"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=ffb2f5920276563941e386260c477317"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=ffb2f5920276563941e386260c477317"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=ffb2f5920276563941e386260c477317"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=ffb2f5920276563941e386260c477317"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=ffb2f5920276563941e386260c477317"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=ffb2f5920276563941e386260c477317"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=ffb2f5920276563941e386260c477317"/><title data-react-helmet="true">两天实现光线追踪 2 - 坐标系与形状 | 随便写写</title><link data-react-helmet="true" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.css" rel="stylesheet"/><meta data-react-helmet="true" name="description" content="坐标系 画布坐标系 上一节中已经有了一个根据坐标来渲染的函数  rederPixel , 现在我们把它抽象一下, 具体渲染的逻辑交给别的函数去做.
重新定义画布坐标系, 向右为 x 正方向, 范围从 0 到 1, 向上为 y 正方向, 范围也是 0 到…"/><meta data-react-helmet="true" property="og:title" content="两天实现光线追踪 2 - 坐标系与形状"/><meta data-react-helmet="true" property="og:description" content="坐标系 画布坐标系 上一节中已经有了一个根据坐标来渲染的函数  rederPixel , 现在我们把它抽象一下, 具体渲染的逻辑交给别的函数去做.
重新定义画布坐标系, 向右为 x 正方向, 范围从 0 到 1, 向上为 y 正方向, 范围也是 0 到…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="acdzh"/><meta data-react-helmet="true" name="twitter:title" content="两天实现光线追踪 2 - 坐标系与形状"/><meta data-react-helmet="true" name="twitter:description" content="坐标系 画布坐标系 上一节中已经有了一个根据坐标来渲染的函数  rederPixel , 现在我们把它抽象一下, 具体渲染的逻辑交给别的函数去做.
重新定义画布坐标系, 向右为 x 正方向, 范围从 0 到 1, 向上为 y 正方向, 范围也是 0 到…"/><link as="script" rel="preload" href="/webpack-runtime-eadd60745f2c20ad7d5b.js"/><link as="script" rel="preload" href="/framework-eb684e3e828ad13b3940.js"/><link as="script" rel="preload" href="/app-0acea366b700cb2006c4.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/8c3ff73a-c498f4d9bc8664bd7de9.js"/><link as="script" rel="preload" href="/commons-952fdd3eb3e92eb702de.js"/><link as="script" rel="preload" href="/component---src-templates-post-tsx-18a2e622c97be6b86328.js"/><link as="fetch" rel="preload" href="/page-data/tec/2020-12/realize_ray_tracing_in_two_days_2/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2841359383.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3017845491.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3975179661.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="global-wrapper" style="height:100vh;display:flex;flex-direction:column"><div class="nav-expand-menu hidden"><a rel="nofollow" href="/"><div class="nav-expand-menu-item nav-expand-menu-item-obj"><i class="fas fa-home" aria-hidden="true"></i>  Index</div></a><a rel="nofollow" href="/categories/"><div class="nav-expand-menu-item nav-expand-menu-item-obj"><i class="fas fa-folder-open" aria-hidden="true"></i>  <!-- -->Categories</div></a><a rel="nofollow" href="/series/"><div class="nav-expand-menu-item nav-expand-menu-item-obj"><i class="fas fa-bookmark" aria-hidden="true"></i>  <!-- -->Series</div></a><a rel="nofollow" href="/tags"><div class="nav-expand-menu-item nav-expand-menu-item-obj"><i class="fas fa-tags" aria-hidden="true"></i>  <!-- -->Tags</div></a><a rel="nofollow" href="/about"><div class="nav-expand-menu-item nav-expand-menu-item-obj"><i class="fas fa-user" aria-hidden="true"></i>  <!-- -->About</div></a><a rel="nofollow" href="/rss.xml"><div class="nav-expand-menu-item nav-expand-menu-item-obj"><i class="fas fa-heart" aria-hidden="true"></i>  <!-- -->RSS</div></a><div class="nav-expand-menu-item nav-expand-menu-item-text">---0-0-0---</div></div><nav class="nav"><div class="nav-inner"><div class="nav-menu nav-menu-left"><button class="nav-menu-item nav-menu-item-button nav-menu-item-bar"><i class="fa fa-bars" aria-hidden="true"></i></button><a rel="nofollow" href="/"><div class="nav-menu-item nav-menu-item-obj"><i class="fas fa-home" aria-hidden="true"></i>  Index</div></a><a rel="nofollow" href="/categories/"><div class="nav-menu-item nav-menu-item-obj"><i class="fas fa-folder-open" aria-hidden="true"></i>  <!-- -->Categories</div></a><a rel="nofollow" href="/series/"><div class="nav-menu-item nav-menu-item-obj"><i class="fas fa-bookmark" aria-hidden="true"></i>  <!-- -->Series</div></a><a rel="nofollow" href="/tags"><div class="nav-menu-item nav-menu-item-obj"><i class="fas fa-tags" aria-hidden="true"></i>  <!-- -->Tags</div></a><a rel="nofollow" href="/about"><div class="nav-menu-item nav-menu-item-obj"><i class="fas fa-user" aria-hidden="true"></i>  <!-- -->About</div></a><a rel="nofollow" href="/rss.xml"><div class="nav-menu-item nav-menu-item-obj"><i class="fas fa-heart" aria-hidden="true"></i>  <!-- -->RSS</div></a><div class="nav-menu-item nav-menu-item-text">---0-0-0---</div></div><div class="nav-menu nav-menu-right"><button class="nav-menu-item nav-menu-item-button"><i class="fa" aria-hidden="true"></i></button></div></div></nav><div class="content-main-container"><main class="content-main" style="display:flex;flex-direction:row"><div style="flex:1"><div class="card-container" style="background-color:var(--BgPrimary)"><div class="card-container-top card-container-top__const"><div class="card-container-top-inner"><ul><li><a title="All posts in category 技术" rel="category tag" href="/categories/技术">技术</a></li><li><a title="All posts in category 计算机图形学" rel="category tag" href="/categories/计算机图形学">计算机图形学</a></li><li><a title="All posts in series 两天实现光线追踪" rel="series tag" href="/series/两天实现光线追踪">两天实现光线追踪</a></li></ul></div><div class="card-container-top-fold-button" role="button" tabindex="-1"><i class="fa fa-chevron-up" aria-hidden="true"></i></div></div><div class="card-content"><div class="post-container"><article class="post"><h1 class="post-title">两天实现光线追踪 2 - 坐标系与形状</h1><p class="post-meta">by <!-- -->acdzh<!-- --> · <!-- -->2020年12月31日 08:00:20<!-- --> · <!-- -->160<!-- --> WORDS  ·  ~ <!-- -->1<!-- --> mins reading time · <span id="" class="leancloud_visitors" data-flag-title="两天实现光线追踪 2 - 坐标系与形状"><span class="leancloud-visitors-count"></span></span>  Visitors | <a href="//github.com/acdzh/gatsby-blog-src/blob/master/blog/tec/2020-12/两天实现光线追踪 2 - 坐标系与形状/index.md" target="_blank" rel="noreferrer">raw on <i class="fab fa-github"></i></a></p><div class="post-entry"><h2 id="坐标系">坐标系</h2><h3 id="画布坐标系">画布坐标系</h3><p>上一节中已经有了一个根据坐标来渲染的函数 <code class="language-text">rederPixel</code>, 现在我们把它抽象一下, 具体渲染的逻辑交给别的函数去做.
重新定义画布坐标系, 向右为 x 正方向, 范围从 0 到 1, 向上为 y 正方向, 范围也是 0 到 1. 因为透明度基本用不到, 直接写死就可以.</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> <span class="token function-variable function">color</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">renderPixel</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  v<span class="token operator">:</span> Pixel<span class="token punctuation">,</span>
  width<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  height<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>v<span class="token punctuation">.</span>r<span class="token punctuation">,</span> v<span class="token punctuation">.</span>g<span class="token punctuation">,</span> v<span class="token punctuation">.</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">color</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>x <span class="token operator">/</span> width<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> v<span class="token punctuation">.</span>y <span class="token operator">/</span> height<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>v <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>v <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:650px">
      <a class="gatsby-resp-image-link" href="/static/7f235cbe8d3dae6cd82a3e56595f29c4/21b4d/210318154041.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:72.39263803680981%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACVElEQVQ4y62PXUiTURzGX/Aqog/tIqh076ubIcxNN8WKLBd93Wwg4WUIDTJT20TLFCzspg+ce7cZuElZFOwqECK8MHQyN0ZXQ9xHN3VVmx9br2bl1nn3dE6RYIkG9ocfz+Fwnh/nzwkKwajRaKHT10Cj1UNVWgYFr8ShQgFFimKaPA4cLNoEBXhBCXV5JXi+xMi1XG01OexODIouItrsxGETZafdIbtEl/zQOSg7BkS5/37/ZhDbAxuhiZbmFhMXCoVM+DW5bQLm4iYmJkyrq6uQZTlHCMlB3uCpvJ4cRaYQBu2wLnMwF+fz+UzZbHbth69WnkL8ZMWw1I0RqQte6SZGKeNL3QhSZpZ68H65F4vL15H9+mytxxzM9ZfwXsQC45QSjQEdmqYr0DFdiTv07Aro8TxYhbFgNd6EjuJdQIPP8c6thbfH2mBwCmhwV6BxqBxtbg163VoMeCrxxKPDy+EqBB8dwdshDaTxfxC2e8xQX87HGauA+msKXLLw6LQIuGstgaddhRcdhzF1Q41ZSzFSI61bCy92XUBBBQdd7U6cOr4DDTSbT+zGrZN74TLsg/f0frw+X4hwXQEW+sxbC69YzChV5uOsnq6t49FUVYyeGhX6j5Xhca0aowYt/OeqMVunxmLfBitPTk4aM5kMvcqRHCWdSpPkh49kIZEkqUSCpGlKySRZpqzMzZEvlG/z8yRD87sk/exQIWEO5uL8fn89/tMwF+f1emsjkchMPB4Px2KxcDQaDUcjEZq/ia4j9ie0w7rMwVwcnTzKLsqebcIceT8Avp0WkBvI8DYAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="210318154041" title="210318154041" src="/static/7f235cbe8d3dae6cd82a3e56595f29c4/a6d36/210318154041.png" srcSet="/static/7f235cbe8d3dae6cd82a3e56595f29c4/222b7/210318154041.png 163w,/static/7f235cbe8d3dae6cd82a3e56595f29c4/ff46a/210318154041.png 325w,/static/7f235cbe8d3dae6cd82a3e56595f29c4/a6d36/210318154041.png 650w,/static/7f235cbe8d3dae6cd82a3e56595f29c4/e548f/210318154041.png 975w,/static/7f235cbe8d3dae6cd82a3e56595f29c4/21b4d/210318154041.png 1280w" sizes="(max-width: 650px) 100vw, 650px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><h3 id="空间坐标系">空间坐标系</h3><h4 id="向量">向量</h4><p>我们定义一个向量类 <code class="language-text">Vec3</code>, 既能装 <code class="language-text">x, y, z</code> 坐标, 也能顺便装一下 <code class="language-text">r, g, b</code> 色值. 再定义一堆三维向量的运算.</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Vec3</span> <span class="token punctuation">{</span>
  e0<span class="token operator">:</span> <span class="token builtin">number</span>
  e1<span class="token operator">:</span> <span class="token builtin">number</span>
  e2<span class="token operator">:</span> <span class="token builtin">number</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>e0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> e1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> e2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>e0 <span class="token operator">=</span> e0
    <span class="token keyword">this</span><span class="token punctuation">.</span>e1 <span class="token operator">=</span> e1
    <span class="token keyword">this</span><span class="token punctuation">.</span>e2 <span class="token operator">=</span> e2
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">fill</span><span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> Vec3 <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">add</span><span class="token punctuation">(</span>v1<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> v2<span class="token operator">:</span> Vec3<span class="token punctuation">)</span><span class="token operator">:</span> Vec3 <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>e0 <span class="token operator">+</span> v2<span class="token punctuation">.</span>e0<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>e1 <span class="token operator">+</span> v2<span class="token punctuation">.</span>e1<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>e2 <span class="token operator">+</span> v2<span class="token punctuation">.</span>e2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">sub</span><span class="token punctuation">(</span>v1<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> v2<span class="token operator">:</span> Vec3<span class="token punctuation">)</span><span class="token operator">:</span> Vec3 <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>e0 <span class="token operator">-</span> v2<span class="token punctuation">.</span>e0<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>e1 <span class="token operator">-</span> v2<span class="token punctuation">.</span>e1<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>e2 <span class="token operator">-</span> v2<span class="token punctuation">.</span>e2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">mul</span><span class="token punctuation">(</span>v1<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> v2<span class="token operator">:</span> Vec3<span class="token punctuation">)</span><span class="token operator">:</span> Vec3 <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>e0 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e0<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>e1 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e1<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>e2 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">div</span><span class="token punctuation">(</span>v1<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> v2<span class="token operator">:</span> Vec3<span class="token punctuation">)</span><span class="token operator">:</span> Vec3 <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>e0 <span class="token operator">/</span> v2<span class="token punctuation">.</span>e0<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>e1 <span class="token operator">/</span> v2<span class="token punctuation">.</span>e1<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>e2 <span class="token operator">/</span> v2<span class="token punctuation">.</span>e2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">dot</span><span class="token punctuation">(</span>v1<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> v2<span class="token operator">:</span> Vec3<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> v1<span class="token punctuation">.</span>e0 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e0 <span class="token operator">+</span> v1<span class="token punctuation">.</span>e1 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e1 <span class="token operator">+</span> v1<span class="token punctuation">.</span>e2 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e2
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">cross</span><span class="token punctuation">(</span>v1<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> v2<span class="token operator">:</span> Vec3<span class="token punctuation">)</span><span class="token operator">:</span> Vec3 <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>v1<span class="token punctuation">.</span>e1 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e2 <span class="token operator">-</span> v1<span class="token punctuation">.</span>e2 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e1<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>v1<span class="token punctuation">.</span>e0 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e2 <span class="token operator">-</span> v1<span class="token punctuation">.</span>e2 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e0<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>v1<span class="token punctuation">.</span>e0 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e1 <span class="token operator">-</span> v1<span class="token punctuation">.</span>e1 <span class="token operator">*</span> v2<span class="token punctuation">.</span>e0<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">add</span><span class="token punctuation">(</span>v<span class="token operator">:</span> Vec3 <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> v <span class="token operator">===</span> <span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Vec3<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Vec3<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Vec3<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">sub</span><span class="token punctuation">(</span>v<span class="token operator">:</span> Vec3 <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> v <span class="token operator">===</span> <span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Vec3<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Vec3<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Vec3<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">mul</span><span class="token punctuation">(</span>v<span class="token operator">:</span> Vec3 <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> v <span class="token operator">===</span> <span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Vec3<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Vec3<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Vec3<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">div</span><span class="token punctuation">(</span>v<span class="token operator">:</span> Vec3 <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> v <span class="token operator">===</span> <span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Vec3<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Vec3<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Vec3<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token function">squaredLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>e0 <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>e1 <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>e2 <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">squaredLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">unitVec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span>Vec3<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>e0<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>e1<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>e2<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><h4 id="光线">光线</h4><p>下面实现一个光线追踪的核心类, <code class="language-text">Ray</code> 光线类, 包括光线的起始点和方向, 以及一个计算在 <code class="language-text">t</code> 时间后光线位置的方法.</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> Vec3 <span class="token keyword">from</span> <span class="token string">&#x27;./Vec3&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Ray</span> <span class="token punctuation">{</span>
  origin<span class="token operator">:</span> Vec3<span class="token punctuation">;</span>
  direction<span class="token operator">:</span> Vec3<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>origin<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> direction<span class="token operator">:</span> Vec3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>origin <span class="token operator">=</span> origin<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>direction <span class="token operator">=</span> direction<span class="token punctuation">.</span><span class="token function">unitVec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getPoint</span><span class="token punctuation">(</span>t<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p><code class="language-text">direction</code> 理论上是单位向量, 所以这里的 <code class="language-text">t</code> 名义上是时间, 实际上与坐标系中的距离是一比一对应的 (速度为 1, 后续涉及到运动模糊时会详细这部分). </p><h4 id="camera">Camera</h4><p>接着我们先实现一个简陋的摄像机, 用来发出光线. 这个类包括两部分, 摄影机的位置和发出光线的范围, 如下图.</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> Vec3 <span class="token keyword">from</span> <span class="token string">&#x27;./Vec3&#x27;</span>
<span class="token keyword">import</span> Ray <span class="token keyword">from</span> <span class="token string">&#x27;./Ray&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Camera</span> <span class="token punctuation">{</span>
  origin<span class="token operator">:</span> Vec3<span class="token punctuation">;</span>
  vertical<span class="token operator">:</span> Vec3<span class="token punctuation">;</span>
  horizontal<span class="token operator">:</span> Vec3<span class="token punctuation">;</span>
  leftBottom<span class="token operator">:</span> Vec3<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>origin<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> leftBottom<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> horizontal<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> vertical<span class="token operator">:</span> Vec3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>origin <span class="token operator">=</span> origin<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>leftBottom <span class="token operator">=</span> leftBottom<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vertical <span class="token operator">=</span> vertical<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>horizontal <span class="token operator">=</span> horizontal<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getRay</span><span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> Ray <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ray</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>leftBottom
        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>horizontal<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>Vec3<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vertical<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>Vec3<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:650px">
      <a class="gatsby-resp-image-link" href="/static/f70aebcf0a82d29e12e4a17ca8cab7f1/b5cea/210318154505.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:43.558282208588956%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIUlEQVQoz5VR226DMAzt/3/dNGkP3YUHSssCoUBInIsvWShtxfY2S44S28c+OT7kvYnk/9hhA60eLZtzprglfKDJoLGBRBKRA1gAnLP94CxgyRLLYT9Whi+x/XplLv2qelR6nC/nqa69maFtCdOpaWOkjeJz8u3lp4x+61NOrVrf96QU9pr0EKuqBLuuY+YH7Vsdw8Cu1L3x0rEPOM1iZvV5DGOfk5flkgnQLAKgCpjoDmb9wU7TtaLpxPpIp1ds31PzktHO89VasxIJSxZMSpHWSmt6giXMmdOd9mZM4sdMwXmsG10EKOKUMBlTqrpO7WjvFFu/8NhWTGyBzBIBwPvVl0HH4Ovm2wEmFKS92r83/mfrZRqLICZ99cZSiFxW9QMEbwzI06t1KQAAAABJRU5ErkJggg==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="210318154505" title="210318154505" src="/static/f70aebcf0a82d29e12e4a17ca8cab7f1/a6d36/210318154505.png" srcSet="/static/f70aebcf0a82d29e12e4a17ca8cab7f1/222b7/210318154505.png 163w,/static/f70aebcf0a82d29e12e4a17ca8cab7f1/ff46a/210318154505.png 325w,/static/f70aebcf0a82d29e12e4a17ca8cab7f1/a6d36/210318154505.png 650w,/static/f70aebcf0a82d29e12e4a17ca8cab7f1/e548f/210318154505.png 975w,/static/f70aebcf0a82d29e12e4a17ca8cab7f1/b5cea/210318154505.png 1140w" sizes="(max-width: 650px) 100vw, 650px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><p><code class="language-text">origin</code> 是摄像机的坐标, <code class="language-text">leftBottom</code> 是左下角的坐标, 而 <code class="language-text">vertical</code> 和 <code class="language-text">horizontal</code> 则是两个向量. 上图所示的摄像机构造如下:</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Camera</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//origin</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//leftBottom</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//horizontal: Vec3(2, -1, -1) - Vec3(-2, -2, -1)</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//vertical: Vec3(-2, 1, -2) - Vec3(-2, -1, -2)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>另外 <code class="language-text">Camera</code> 类还有一个获取光线的方法, 这里接受两个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> 的参数 (即上面提到的画布坐标), 并将它们映射到我们摄像机的投影范围上.</p><h3 id="背景">背景</h3><p>下面就可以开始正式渲染了. 首先我们需要一张背景, 同时作为整个场景的光源来使用. 我们希望这张背景径向渐变, 可以根据每一点的光线方向的单位向量来生成背景颜色. 令每一条光线的单位向量 <code class="language-text">unitDirection</code>, 我们可以简单计算<code class="language-text">unitDirection</code> 的 y 的取值范围. 设摄像机的范围矩形 (我也不知道这个东西取个什么名好) 从上面中点为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal">A</span></span></span></span></span>, 下边终点为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.05017em">B</span></span></span></span></span>, 摄像机位置为点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span></span></span></span></span>, 那么</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mrow><mi>O</mi><mi>A</mi></mrow><mo stretchy="true">→</mo></mover><mo>=</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\overrightarrow{OA} = [0, 1, 0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.20533em;vertical-align:0em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mord mathnormal">A</span></span></span><span class="svg-align" style="top:-3.6833299999999998em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em"><svg width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"></path></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">0</span><span class="mclose">]</span></span></span></span></span></div><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mrow><mi>O</mi><mi>B</mi></mrow><mo stretchy="true">→</mo></mover><mo>=</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\overrightarrow{OB} = [0, -1, 0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.20533em;vertical-align:0em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mord mathnormal" style="margin-right:0.05017em">B</span></span></span><span class="svg-align" style="top:-3.6833299999999998em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em"><svg width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"></path></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">0</span><span class="mclose">]</span></span></span></span></span></div><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mrow><mi>O</mi><mi>A</mi></mrow><mo>^</mo></mover><mo>=</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\hat{OA} = [0, 1, 0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9467699999999999em;vertical-align:0em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mord mathnormal">A</span></span></span><span style="top:-3.25233em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.25em"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">0</span><span class="mclose">]</span></span></span></span></span></div><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mrow><mi>O</mi><mi>B</mi></mrow><mo>^</mo></mover><mo>=</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\hat{OB} = [0, -1, 0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9467699999999999em;vertical-align:0em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9467699999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mord mathnormal" style="margin-right:0.05017em">B</span></span></span><span style="top:-3.25233em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.25em"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">0</span><span class="mclose">]</span></span></span></span></span></div><p>因此该取值范围是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-1, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>, 归一化到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> 即可. 之后我们写一个简单的蓝白渐变, 如下</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> Px <span class="token keyword">from</span> <span class="token string">&#x27;../lib/Pixel&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Ray <span class="token keyword">from</span> <span class="token string">&#x27;../lib/Ray&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Vec3 <span class="token keyword">from</span> <span class="token string">&#x27;../lib/Vec3&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Camera <span class="token keyword">from</span> <span class="token string">&#x27;../lib/Camera&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Camera</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//origin</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//leftBottom</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//horizontal</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//vertical</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> r <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">getRay</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> unitDirection <span class="token operator">=</span> r<span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">unitVec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token punctuation">(</span>unitDirection<span class="token punctuation">.</span>e1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

  <span class="token comment">// color</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span>  Vec3<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:650px">
      <a class="gatsby-resp-image-link" href="/static/b14b2773067ccfd5bda8812d550622ca/21b4d/210318154929.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:72.39263803680981%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABxUlEQVQ4y62S30obQRSHF7wuvVebxCCFCLGW0ss+Qhb6GG36IurGbBJ722Ip3aiglBbRNO4GtwkBU5VqyNo732Ln7Mz+Oie7UoqiUjvwMWfOn4/ZYY18Ll+aL85j4elzPFl4htnHBWRzs5h+NINMNq/3HCanMteQHe9T0zkU5oooFIvIzORLRvn1G7NerWO11pB2pSprFVvVqzXVsBvqbX1V1VZsZS1aNyGr1oq0liyUX5VNo9/vm0hWfE/ALsN1XTMMQyilYimlLkj8QeHv81V4hmfZwS6j0+mYRJTeMI57ZxGcNmHTIzRdAWdf4FM7geOmhmvOPqF7GvHY+IbsYNcV4ZcuYckJYW+GqKyHsJohllM45hzXlnXP5+/idqF3THi3I/CxJfBhL2FtN+HyzLX3usc9otuF/MnrnsC2T9g6IGwzfspBmtPxhu7pnt5BODiP8LVHaB0mfBsQ2ikcX+a55zC4wxsGFxF6Z9xMGGh+nBOOfkVjOOYc17hndHGN0PO8khD8uJBxrCRFSoZCSkE3wz1Eiv+Z8f/DDnYZvu+/xH9a7DIcx3kxHA5/BkFwMhqN/gmeZQe7DL0mNA80D+8JOyZ+A1flZKa9t/4oAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="210318154929" title="210318154929" src="/static/b14b2773067ccfd5bda8812d550622ca/a6d36/210318154929.png" srcSet="/static/b14b2773067ccfd5bda8812d550622ca/222b7/210318154929.png 163w,/static/b14b2773067ccfd5bda8812d550622ca/ff46a/210318154929.png 325w,/static/b14b2773067ccfd5bda8812d550622ca/a6d36/210318154929.png 650w,/static/b14b2773067ccfd5bda8812d550622ca/e548f/210318154929.png 975w,/static/b14b2773067ccfd5bda8812d550622ca/21b4d/210318154929.png 1280w" sizes="(max-width: 650px) 100vw, 650px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><h2 id="形状">形状</h2><h3 id="sdf">SDF</h3><p>射线与三角形求交是光线追踪渲染中计算量最大的部分, 这也是光线追踪最大的瓶颈. Nvidia 从 Turing 架构开始为 GPU 加入了 RT core, 用来处理求交, 这也是 RTX 显卡的名称来源. 在我们的玩具 demo 中, 没有复杂的模型, 因此光线与物体的碰撞检测需要交给每个形状自己判断. 因此我们抽象出一个 Hitable 接口和一个 HitRecord 类分别用来求交和记录求交结果. 代码如下</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> Ray <span class="token keyword">from</span> <span class="token string">&#x27;../base/Ray&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> HitRecord <span class="token keyword">from</span> <span class="token string">&#x27;./HitRecord&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">interface</span> <span class="token class-name">Hitable</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">hit</span><span class="token operator">:</span> <span class="token punctuation">(</span>ray<span class="token operator">:</span> Ray<span class="token punctuation">,</span> t_min<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> t_max<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> HitRecord<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p><code class="language-text">Hitable</code> 接口只提供定义, 具体由各个形状自行实现. </p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> Vec3 <span class="token keyword">from</span> <span class="token string">&#x27;../base/Vec3&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">HitRecord</span> <span class="token punctuation">{</span>
  t<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  p<span class="token operator">:</span> Vec3<span class="token punctuation">;</span>
  normal<span class="token operator">:</span> Vec3<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> p<span class="token operator">:</span> Vec3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normal<span class="token operator">:</span> Vec3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>t <span class="token operator">=</span> t<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>p <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>normal <span class="token operator">=</span> normal<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p><code class="language-text">HitRecord</code> 记录了时间参数 <code class="language-text">t</code>, 碰撞发生的位置 <code class="language-text">p</code>, 以及碰撞处的法线方向 <code class="language-text">normal</code>.</p><h3 id="球">球</h3><p>下面我们实现一个球. 显然一个球需要两个值: 球心和半径.</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">import</span> Vec3 <span class="token keyword">from</span> <span class="token string">&quot;../base/Ray&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Sphere</span> <span class="token punctuation">{</span>
  center<span class="token operator">:</span> Vec3<span class="token punctuation">;</span>
  radius<span class="token operator">:</span> <span class="token builtin">number</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>center<span class="token operator">:</span> Vec3<span class="token punctuation">,</span> r<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>center <span class="token operator">=</span> center<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>radius <span class="token operator">=</span> r<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>此外就需要实现 <code class="language-text">Hitable</code> 接口. 设光线起始点为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>O</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>O</mi></msub><mo separator="true">,</mo><msub><mi>z</mi><mi>O</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(x_O, y_O, z_O)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>, 方向为向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>d</mi><mo>⃗</mo></mover><mo>=</mo><mo stretchy="false">[</mo><msub><mi>d</mi><mi>x</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mi>y</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mi>z</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\vec{d}=[d_x, d_y, d_z]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9774399999999999em;vertical-align:0em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774399999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.26344em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.06882999999999997em"><span class="overlay" style="height:0.714em;width:0.471em"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span>, 假设 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em"></span><span class="mord mathnormal">t</span></span></span></span></span> 时间时与球表面相交, 此时光线位置为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>P</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>P</mi></msub><mo separator="true">,</mo><msub><mi>z</mi><mi>P</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_P, y_P, z_P)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>, 那么:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mrow><mi>N</mi><mi>P</mi></mrow><mo stretchy="true">→</mo></mover><mo>=</mo><mi>t</mi><mover accent="true"><mi>d</mi><mo>⃗</mo></mover><mo>=</mo><mo stretchy="false">[</mo><mi>t</mi><msub><mi>d</mi><mi>x</mi></msub><mo separator="true">,</mo><mi>t</mi><msub><mi>d</mi><mi>y</mi></msub><mo separator="true">,</mo><mi>t</mi><msub><mi>d</mi><mi>z</mi></msub><mo stretchy="false">]</mo><mo>=</mo><mo stretchy="false">[</mo><msub><mi>x</mi><mi>P</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>P</mi></msub><mo separator="true">,</mo><msub><mi>z</mi><mi>P</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\overrightarrow{NP} =t\vec{d} = [ td_x, td_y, td_z] = [x_P, y_P, z_P]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.20533em;vertical-align:0em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em">N</span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span><span class="svg-align" style="top:-3.6833299999999998em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em"><svg width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"></path></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.9774399999999999em;vertical-align:0em"></span><span class="mord mathnormal">t</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774399999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.26344em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.06882999999999997em"><span class="overlay" style="height:0.714em;width:0.471em"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em"></span><span class="mopen">[</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></div><p>设球心坐标为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>C</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>C</mi></msub><mo separator="true">,</mo><msub><mi>z</mi><mi>C</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C(x_C, y_C, z_C)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>, 半径为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.02778em">r</span></span></span></span></span> 此时满足 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mover accent="true"><mrow><mi>C</mi><mi>P</mi></mrow><mo stretchy="true">→</mo></mover><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mo>=</mo><mi>r</mi></mrow><annotation encoding="application/x-tex">||\overrightarrow{CP}|| = r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.45533em;vertical-align:-0.25em"></span><span class="mord">∣</span><span class="mord">∣</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span><span class="svg-align" style="top:-3.6833299999999998em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em"><svg width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"></path></svg></span></span></span></span></span></span><span class="mord">∣</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em"></span><span class="mord mathnormal" style="margin-right:0.02778em">r</span></span></span></span></span>. 而</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mrow><mi>C</mi><mi>P</mi></mrow><mo stretchy="true">→</mo></mover><mo>=</mo><mover accent="true"><mrow><mi>C</mi><mi>N</mi></mrow><mo stretchy="true">→</mo></mover><mo>+</mo><mover accent="true"><mrow><mi>O</mi><mi>P</mi></mrow><mo stretchy="true">→</mo></mover><mo>=</mo><mo stretchy="false">[</mo><msub><mi>x</mi><mi>O</mi></msub><mo>−</mo><msub><mi>x</mi><mi>C</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>O</mi></msub><mo>−</mo><msub><mi>y</mi><mi>C</mi></msub><mo separator="true">,</mo><msub><mi>z</mi><mi>O</mi></msub><mo>−</mo><msub><mi>z</mi><mi>C</mi></msub><mo stretchy="false">]</mo><mo>+</mo><mo stretchy="false">[</mo><mi>t</mi><msub><mi>d</mi><mi>x</mi></msub><mo separator="true">,</mo><mi>t</mi><msub><mi>d</mi><mi>y</mi></msub><mo separator="true">,</mo><mi>t</mi><msub><mi>d</mi><mi>z</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\overrightarrow{CP} = \overrightarrow{CN} + \overrightarrow{OP} = [x_O-x_C, y_O-y_C, z_O-z_C] + [td_x, td_y, td_z]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.20533em;vertical-align:0em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span><span class="svg-align" style="top:-3.6833299999999998em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em"><svg width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"></path></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.28866em;vertical-align:-0.08333em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em">C</span><span class="mord mathnormal" style="margin-right:0.10903em">N</span></span></span><span class="svg-align" style="top:-3.6833299999999998em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em"><svg width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"></path></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.20533em;vertical-align:0em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span><span class="svg-align" style="top:-3.6833299999999998em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em"><svg width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"></path></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em"></span><span class="mopen">[</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></div><p>综上有一元二次方程:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mi>t</mi><msub><mi>d</mi><mi>x</mi></msub><mo>+</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mi>O</mi></msub><mo>−</mo><msub><mi>x</mi><mi>C</mi></msub><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>t</mi><msub><mi>d</mi><mi>y</mi></msub><mo>+</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mi>O</mi></msub><mo>−</mo><msub><mi>y</mi><mi>C</mi></msub><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>t</mi><msub><mi>d</mi><mi>z</mi></msub><mo>+</mo><mo stretchy="false">(</mo><msub><mi>z</mi><mi>O</mi></msub><mo>−</mo><msub><mi>z</mi><mi>C</mi></msub><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><msup><mi>r</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(td_x+(x_O-x_C))^2 + (td_y+(y_O-y_C))^2 + (td_z +(z_O-z_C))^2 = r^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em"></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-0.04398em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.8641079999999999em;vertical-align:0em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></div><p>整理得:</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mover accent="true"><mi>d</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mi>d</mi><mo>⃗</mo></mover><mo stretchy="false">)</mo><msup><mi>t</mi><mn>2</mn></msup><mo>+</mo><mn>2</mn><mo stretchy="false">(</mo><mover accent="true"><mi>d</mi><mo>⃗</mo></mover><mo>⋅</mo><mover accent="true"><mrow><mi>O</mi><mi>C</mi></mrow><mo stretchy="true">→</mo></mover><mo stretchy="false">)</mo><mi>t</mi><mo>+</mo><mo stretchy="false">(</mo><mover accent="true"><mrow><mi>O</mi><mi>C</mi></mrow><mo stretchy="true">→</mo></mover><mo>⋅</mo><mover accent="true"><mrow><mi>O</mi><mi>C</mi></mrow><mo stretchy="true">→</mo></mover><mo>−</mo><msup><mi>r</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">(\vec{d} \cdot\vec{d})t^2 + 2(\vec{d}\cdot\overrightarrow{OC})t + (\overrightarrow{OC}\cdot\overrightarrow{OC} - r^2) = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2274399999999999em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774399999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.26344em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.06882999999999997em"><span class="overlay" style="height:0.714em;width:0.471em"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.2274399999999999em;vertical-align:-0.25em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774399999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.26344em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.06882999999999997em"><span class="overlay" style="height:0.714em;width:0.471em"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.2274399999999999em;vertical-align:-0.25em"></span><span class="mord">2</span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9774399999999999em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.26344em"><span class="pstrut" style="height:3em"></span><span class="accent-body" style="left:-0.06882999999999997em"><span class="overlay" style="height:0.714em;width:0.471em"><svg width="0.471em" height="0.714em" style="width:0.471em" viewBox="0 0 471 714" preserveAspectRatio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z"></path></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.45533em;vertical-align:-0.25em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mord mathnormal" style="margin-right:0.07153em">C</span></span></span><span class="svg-align" style="top:-3.6833299999999998em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em"><svg width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"></path></svg></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.45533em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mord mathnormal" style="margin-right:0.07153em">C</span></span></span><span class="svg-align" style="top:-3.6833299999999998em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em"><svg width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"></path></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.28866em;vertical-align:-0.08333em"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">O</span><span class="mord mathnormal" style="margin-right:0.07153em">C</span></span></span><span class="svg-align" style="top:-3.6833299999999998em"><span class="pstrut" style="height:3em"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em"><svg width="400em" height="0.522em" viewBox="0 0 400000 522" preserveAspectRatio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"></path></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em"><span style="top:-3.113em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em"></span><span class="mord">0</span></span></span></span></span></div><p>解此方程即可.</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token function">hit</span><span class="token punctuation">(</span>ray<span class="token operator">:</span> Ray<span class="token punctuation">,</span> t_min<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> t_max<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oc <span class="token operator">=</span> Vec3<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>center<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> a <span class="token operator">=</span> Vec3<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>ray<span class="token punctuation">.</span>direction<span class="token punctuation">,</span> ray<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> b <span class="token operator">=</span> Vec3<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> ray<span class="token punctuation">.</span>direction<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> c <span class="token operator">=</span> Vec3<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> oc<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>radius <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> Δ <span class="token operator">=</span> b <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">4</span> <span class="token operator">*</span> a <span class="token operator">*</span> c<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>Δ <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sqrtΔ <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>Δ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span>b <span class="token operator">-</span> sqrtΔ<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&gt;</span> t_min <span class="token operator">&amp;&amp;</span> t <span class="token operator">&lt;</span> t_max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> p <span class="token operator">=</span> ray<span class="token punctuation">.</span><span class="token function">getPoint</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HitRecord</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>center<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>radius<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span>b <span class="token operator">+</span> sqrtΔ<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&gt;</span> t_min <span class="token operator">&amp;&amp;</span> t <span class="token operator">&lt;</span> t_max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> p <span class="token operator">=</span> ray<span class="token punctuation">.</span><span class="token function">getPoint</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HitRecord</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>center<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>radius<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p>现在我们把这个球添加到空间里, 规定当光线打到球上时, 就返回绿色.</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Camera</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//origin</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//leftBottom</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//horizontal</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//vertical</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ball <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> r <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">getRay</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hit <span class="token operator">=</span> ball<span class="token punctuation">.</span><span class="token function">hit</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">Infinity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> res<span class="token operator">:</span> Vec3<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>hit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">37</span> <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">244</span> <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">238</span> <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> unitDirection <span class="token operator">=</span> r<span class="token punctuation">.</span>direction<span class="token punctuation">.</span><span class="token function">unitVec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token punctuation">(</span>unitDirection<span class="token punctuation">.</span>e1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span>  Vec3<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:650px">
      <a class="gatsby-resp-image-link" href="/static/209c070d96b9998975c73ff7e4275396/78302/210318160024.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:72.39263803680981%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACTElEQVQ4y6WS70tTURjH7/us7OdYZYkvIqEIw3f9I/le3ywKC6PCytKcQ80VvdB+bxekWCUYJr5Iy2ag23Q6oS3mr9wGtpyKtt17z733fHvu7oJRMcMufDgPz3PPh+ec8wilVsvpsrKSF0fLT7iPlR8XDx4qFffstYjbiorFou27iOKC7Ni5W9y33ypaSw67S46UHhDqai+edbbdwd12Jzpa29Fqd6ClqRn2xttE86a0NNlx33kPzo4OVJ2pqhTC4XA1zE8h1P9A83g8FYLf769RVRW6rmuarnPgb2g5/qxpmsZ1ziFJElwu1ylhfHy8hmRGh+TTeWiGwRsy+TDJMDTBMDhG+CgOMgxTboRqH6cYojFG28hmHE9R4Ha7TaGWE1Kn/OnbNG65ZEJC/WMJlzsl1HancUFM4wrF155IaHJLaHgmo9ebhtElLyTsGU7jwRsFD/tkdL1WYB/bQN2PZVxaTaHtfRpdPQoe9Sno7FUwFMjAPPpvQj1PODCawfNBhpfDCnpovRlfw/n1ZZzb+I626Ho2Z9S63yn4FPoHoXdKwoBPxSDd3UhQxatZCVdXVtCQWkV/RIY3aNb6R1VMfJEKCxkJfZ8zGJlW4Y8wTM6oiMxpCNLlhxYZwkYcpVrYfJzp2U06NF45lkjxmYVvfH4xyb/GiHiSJ4h4wowXKGfUovNLfCm5Zsiy5Aurc0JjBrStwhjTRVGsEAKBgC032FmMF6cJN9dcLh8t759fOU6DI8uy0WGl4HA4TlLQSFN+nbixRRrIUW+z2Sw/AZbKizO0jwLbAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="210318160024" title="210318160024" src="/static/209c070d96b9998975c73ff7e4275396/a6d36/210318160024.png" srcSet="/static/209c070d96b9998975c73ff7e4275396/222b7/210318160024.png 163w,/static/209c070d96b9998975c73ff7e4275396/ff46a/210318160024.png 325w,/static/209c070d96b9998975c73ff7e4275396/a6d36/210318160024.png 650w,/static/209c070d96b9998975c73ff7e4275396/e548f/210318160024.png 975w,/static/209c070d96b9998975c73ff7e4275396/3c492/210318160024.png 1300w,/static/209c070d96b9998975c73ff7e4275396/78302/210318160024.png 2798w" sizes="(max-width: 650px) 100vw, 650px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><p>可以稍微修改一下, 用颜色来表示 <code class="language-text">hit</code> 法线方向:</p><div class="gatsby-highlight" data-language="text"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">  if (hit) {
    res = hit.normal.add(1).mul(0.5);
  }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span></span></pre></div><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:650px">
      <a class="gatsby-resp-image-link" href="/static/0e718743c431adef2e3a8f5972a5589c/21b4d/210318160120.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:72.39263803680981%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACDElEQVQ4y62SS2sTURiGB7oWf5AN1SgilYwJNf/BpVsXUhTd1IoWcdVFrKRMoKLWS+xFSEyqBRulDYy5IFWXSZtkJtMzt56Z1+/LWKQLo9geeJgz3+Xh3JSxU7FEMqFiIpUmLmP8wkWci5/HmbH4PxE/fRZJNYVLySRGR2MJ5U0+r5o9A7ZlScs05Z7ZDxjRt4K9PyAOI11hS8swsUQupVQqqUEQgEZ4FNjBLqVQKKi+5w2EYRiEfSGxa0TsEO0e0Y3Y6UWxgzzXcg/3soNdSrFYVH3f/7XCIHxeEpjSXEznHNzOOrjxyMVkxsF1YjLjDmJ3KMc1T98JXlskJAe7DgtDGS6S8N6Ch5knLu7mPNzMWbj2soWHr1q4T/OpXJTjmmckDKlnqHB1Q2BuyUd21YP21sfVTAtXZkzMPujjxVwbjyk+T3DNyse/CDn5vmpjcc3H63U6k8193JrdRXqihel0G8s0X6ZYnnJcs7Zl046HCSn5qe6QKMAHXaLSCPC5KbEwb2Ala2CrIbFBsXXKcU2l5iAYKqQDrm/3UNE7qDY60L920PzexY9WD9+IBs2/UKza7Axqatvd37d8IKSrTnjRs5G8533fk64jpOva9LWlQ9hCSIfg/wGDnJA+1XIP93rRs0ko5XI5hWMa7FI0TYvpul6t1+ubtVrtv+BedrBLoTFCnCBOHhF2jPwEZip8gPB4hRoAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="210318160120" title="210318160120" src="/static/0e718743c431adef2e3a8f5972a5589c/a6d36/210318160120.png" srcSet="/static/0e718743c431adef2e3a8f5972a5589c/222b7/210318160120.png 163w,/static/0e718743c431adef2e3a8f5972a5589c/ff46a/210318160120.png 325w,/static/0e718743c431adef2e3a8f5972a5589c/a6d36/210318160120.png 650w,/static/0e718743c431adef2e3a8f5972a5589c/e548f/210318160120.png 975w,/static/0e718743c431adef2e3a8f5972a5589c/21b4d/210318160120.png 1280w" sizes="(max-width: 650px) 100vw, 650px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><h3 id="蒙特卡洛方法降噪"><a href="https://zh.wikipedia.org/wiki/%E8%92%99%E5%9C%B0%E5%8D%A1%E7%BE%85%E6%96%B9%E6%B3%95">蒙特卡洛方法</a>降噪</h3><p>现在的样子看起来还好, 后期场景复杂以及引入漫反射等随机光线行为时, 可能会因为光线数量不够产生大量噪点. 因此我们可以通过一个点多重采样的方式来进行降噪.</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts">  <span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span>v<span class="token punctuation">.</span>r<span class="token punctuation">,</span> v<span class="token punctuation">.</span>g<span class="token punctuation">,</span> v<span class="token punctuation">.</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> <span class="token function">color</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>x <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> width<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>y <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>item <span class="token operator">+=</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>v <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v <span class="token operator">/</span> n<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255.99</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><h3 id="多个物体">多个物体</h3><p>下面我们实现一个 <code class="language-text">HitList</code>, 这个类存储一个实现了 <code class="language-text">Hitable</code> 接口的物体的数组, 自己也实现了 <code class="language-text">Hitable</code> 接口, 用来计算一系列物体的 <code class="language-text">Hit</code> 情况.</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">HitList</span> <span class="token punctuation">{</span>
  list<span class="token operator">:</span> Hitable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>hitables<span class="token operator">:</span> Hitable<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> hitables<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">hit</span><span class="token punctuation">(</span>ray<span class="token operator">:</span> Ray<span class="token punctuation">,</span> t_min<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> t_max<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> closestT <span class="token operator">=</span> t_max<span class="token punctuation">;</span>
    <span class="token keyword">let</span> hit<span class="token operator">:</span> HitRecord <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>v <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hitTemp <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">hit</span><span class="token punctuation">(</span>ray<span class="token punctuation">,</span> t_min<span class="token punctuation">,</span> t_max<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hitTemp <span class="token operator">&amp;&amp;</span> hitTemp<span class="token punctuation">.</span>t <span class="token operator">&lt;</span> closestT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hit <span class="token operator">=</span> hitTemp<span class="token punctuation">;</span>
        closestT <span class="token operator">=</span> hitTemp<span class="token punctuation">.</span>t<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> hit<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p><code class="language-text">HitList</code> 实现 <code class="language-text">Hitable</code> 接口比较简单粗暴, 直接计算所有物体的 <code class="language-text">hit</code>, 取最小者.</p><p>现在可以再添加几个球了, 顺便调整一下相机位置:</p><div class="gatsby-highlight" data-language="ts"><pre style="counter-reset:linenumber NaN" class="language-ts line-numbers"><code class="language-ts"><span class="token keyword">const</span> camera <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Camera</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// origin</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// leftBottom</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// horizontal</span>
  <span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// vertical</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> world <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HitList</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Sphere</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Vec3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">100.5</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// world</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> hit <span class="token operator">=</span> world<span class="token punctuation">.</span><span class="token function">hit</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">Infinity</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:650px">
      <a class="gatsby-resp-image-link" href="/static/3b3711adf25c2db33614f258ac7bf7a5/21b4d/210318160643.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:61.34969325153374%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACJUlEQVQoz63STW8SQRzH8X1HvgDLQ2miMQZKo5706sWYaKLxYNLGQzlICKAIkRK1TWkQEZSi0O4qT7U0JB6sB1MTE2NisNhKgWUXdpnZnzOA2rSx8eAm3+zs7P4/h8kKluMmu9PuwJmpc6yzOHXyNCZsJ2A1j7NsR2exwWKyYtLuxKTTibExk13IZbOO1l4TqiwTudUivU6b6qpM+2qH9rsHk6k+iq81pUOVtkx6ispnscIsoVwuOyilYJfBa6kw6k0Y30fVf7U3bOcH22+wNaulDGd43OCWUCgUHJqmDUDDIEaq1IEn1oP/SRfuxxrcSzqrB3esC09chStXg1eqw/tUQbLIREoGIDe4JRSLRYeu67/B3EYHvpcdBNdryFS2MJ//hvDrNiJpHdeWN3H+xSZupncwl2gg96bNhugA5Aa3DoHFtxquh1Tc9il4F/yAnK+KZ6GvSIlNTMwUYL76GRdvqPBfUVHOK6A4CuzDKDQqmE5LmLbXIF7YwKIrhQcLz5HsPcLl2EOYrRVcGv+C+9415OvrMAj+DoK9zGiLCGEG97buIPzJgwhmMceKGLOYhwv+jx4E399FmN5CRl84DLKDtI/AvkHRr+6ukeXtOFlpJUiWt50clKsP76tsb1VOkEw9Tqq7ZcKOsM9nucEtoVQqTY1+mz8XfySj6IH27+8fYQa3hEAgcEwUxSVJkqKSKEVFSYyKr/4x9i2f4bPc4JbA8P/aTyrMBaunkRg2AAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="210318160643" title="210318160643" src="/static/3b3711adf25c2db33614f258ac7bf7a5/a6d36/210318160643.png" srcSet="/static/3b3711adf25c2db33614f258ac7bf7a5/222b7/210318160643.png 163w,/static/3b3711adf25c2db33614f258ac7bf7a5/ff46a/210318160643.png 325w,/static/3b3711adf25c2db33614f258ac7bf7a5/a6d36/210318160643.png 650w,/static/3b3711adf25c2db33614f258ac7bf7a5/e548f/210318160643.png 975w,/static/3b3711adf25c2db33614f258ac7bf7a5/21b4d/210318160643.png 1280w" sizes="(max-width: 650px) 100vw, 650px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
  </a>
    </span></p><h2 id="历史记录">历史记录</h2><table><thead><tr><th align="center">Version</th><th align="center">Action</th><th align="center">Time</th></tr></thead><tbody><tr><td align="center">1.0</td><td align="center">Init</td><td align="center">2021-03-18 15:30:02</td></tr></tbody></table><section class="post-entry-license"><p>作者: <!-- -->acdzh<!-- --> <br/>本文出处:  <a target="_blank" rel="noreferrer" href=""></a><br/>互联网日新月异, 请注意文章时效. <br/><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i><i class="fab fa-creative-commons-nc"></i><i class="fab fa-creative-commons-sa"></i></a> 本作品采用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 进行许可. 文章版权归作者所有, 允许转载, 但未经作者同意必须保留此段声明, 且在文章页面明显位置给出原文链接, 否则保留追究法律责任的权利.<br/></p></section><div class="post-tags"><a rel="nofollow" title="All categories" href="/categories/"><i class="fas fa-folder-open"></i></a> <a title="All posts in category 技术" rel="category tag" href="/categories/技术/">技术</a><a title="All posts in category 计算机图形学" rel="category tag" href="/categories/计算机图形学/">计算机图形学</a>   <a rel="nofollow" title="All series" href="/series/"><i class="fas fa-bookmark"></i></a> <a title="All posts in series 两天实现光线追踪" rel="series tag" href="/series/两天实现光线追踪/">两天实现光线追踪</a>   <a rel="nofollow" title="All tags" href="/tags/"><i class="fas fa-tags"></i></a> <a rel="tag" title="All post with tag RTX" href="/tags/RTX">RTX</a><a rel="tag" title="All post with tag 光线追踪" href="/tags/光线追踪">光线追踪</a><a rel="tag" title="All post with tag 图形学" href="/tags/图形学">图形学</a><a rel="tag" title="All post with tag 渲染" href="/tags/渲染">渲染</a></div></div></article></div></div></div></div><div class="content-main-sidebar"><div class="post-sidebar" style="position:sticky;top:60px"><div class="card-container" style="background-color:var(--BgSideBar)"><div class="card-container-top card-container-top__primary"><div class="card-container-top-inner">Catalog</div><div class="card-container-top-fold-button" role="button" tabindex="-1"><i class="fa fa-chevron-up" aria-hidden="true"></i></div></div><div class="card-content"><div class="sidebar-content-post-toc"><ul><li><p><a href="#坐标系">坐标系</a></p><ul><li><a href="#画布坐标系">画布坐标系</a></li><li><p><a href="#空间坐标系">空间坐标系</a></p><ul><li><a href="#向量">向量</a></li><li><a href="#光线">光线</a></li><li><a href="#camera">Camera</a></li></ul></li><li><a href="#背景">背景</a></li></ul></li><li><p><a href="#形状">形状</a></p><ul><li><a href="#sdf">SDF</a></li><li><a href="#球">球</a></li><li><a href="#蒙特卡洛方法降噪">蒙特卡洛方法降噪</a></li><li><a href="#多个物体">多个物体</a></li></ul></li><li><a href="#历史记录">历史记录</a></li></ul></div><div class="sidebar-content-separator"></div><div class="sidebar-content-post-nav"><a rel="next" href="/tec/2020-12/realize_ray_tracing_in_two_days_3/"><div class="sidebar-content-post-nav-item sidebar-content-post-nav-next"><i class="fas fa-chevron-right"></i><div><strong>Next post</strong><span>两天实现光线追踪 3 - 反射与材质</span></div></div></a><div class="sidebar-content-separator"></div><a rel="prev" href="/tec/2020-12/realize_ray_tracing_in_two_days_1/"><div class="sidebar-content-post-nav-item sidebar-content-post-nav-prev"><i class="fas fa-chevron-left"></i><div><strong>Previous Post</strong><span>两天实现光线追踪 1 - 准备工作</span></div></div></a><div class="sidebar-content-separator"></div></div></div></div></div></div></main></div><footer class="footer"><a class="footer-back-topp" href="/tec/2020-12/realize_ray_tracing_in_two_days_2/#"><i class="fas fa-angle-up"></i></a><section class="footer-container"><div class="footer-left-pad"><p>Copyright (c) <!-- -->2021<!-- -->. All rights reserved.</p><p style="margin-top:8px">Power by <a href="https://www.gatsbyjs.com/" target="_blank" rel="noreferrer">Gatsby</a>. Theme <a rel="noreferrer" href="https://github.com/acdzh/gatsby-theme-rapid" target="_blank">rapid</a>.</p></div><div class="footer-right-pad"><div class="footer-sociall-links"><a href="//github.com/acdzh/" target="_blank" rel="noreferrer" title="fork me on github"><i class="fab fa-github" aria-disabled="true"></i></a><a href="//steamcommunity.com/id/acdzh/" target="_blank" rel="noreferrer" title="play games with me"><i class="fab fa-steam" aria-disabled="true"></i></a><a href="//twitter.com/acdzh" target="_blank" rel="noreferrer" title="Twitter"><i class="fab fa-twitter" aria-disabled="true"></i></a><a href="mailto:acdzh@outlook.com" target="_blank" rel="noreferrer" title="Mail"><i class="far fa-envelope" aria-disabled="true"></i></a><a href="tencent://message/?uin=57082212&amp;Site=1069436872&amp;Menu=yes" target="_blank" rel="noreferrer" title="QQ"><i class="fab fa-qq" aria-disabled="true"></i></a><a href="//zhihu.com/people/kkkk-zzzz-13" target="_blank" rel="noreferrer" title="知乎"><i class="fab fa-zhihu" aria-disabled="true"></i></a><div style="font-size:1.1rem;margin-top:10px"><a href="//zhuanlan.zhihu.com/c_1159869906471759872" target="_blank" rel="noreferrer" title="知乎专栏">zhuanlan</a><a href="//cnblogs.com/acdzh" target="_blank" rel="noreferrer" title="博客园">cnblogs</a></div></div></div></section></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-148601605-2', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/tec/2020-12/realize_ray_tracing_in_two_days_2/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-64a2a5ba1fc84f7adec6.js"],"app":["/app-0acea366b700cb2006c4.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-52e91a4845622e8a8558.js"],"component---src-pages-categories-tsx":["/component---src-pages-categories-tsx-7f6479dfdac6f42bb715.js"],"component---src-pages-series-tsx":["/component---src-pages-series-tsx-6e4cccb681c376006967.js"],"component---src-pages-tags-tsx":["/component---src-pages-tags-tsx-e8e9aeb1442ea2c386b8.js"],"component---src-templates-category-tsx":["/component---src-templates-category-tsx-5c1cf6bf4c7226315830.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-18a2e622c97be6b86328.js"],"component---src-templates-posts-tsx":["/component---src-templates-posts-tsx-f48d6173fb5a549f8fba.js"],"component---src-templates-series-tsx":["/component---src-templates-series-tsx-646c8ad9a811a169aca6.js"],"component---src-templates-tag-tsx":["/component---src-templates-tag-tsx-453226d33d7e12cbaf3d.js"]};/*]]>*/</script><script src="/polyfill-64a2a5ba1fc84f7adec6.js" nomodule=""></script><script src="/component---src-templates-post-tsx-18a2e622c97be6b86328.js" async=""></script><script src="/commons-952fdd3eb3e92eb702de.js" async=""></script><script src="/8c3ff73a-c498f4d9bc8664bd7de9.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-0acea366b700cb2006c4.js" async=""></script><script src="/framework-eb684e3e828ad13b3940.js" async=""></script><script src="/webpack-runtime-eadd60745f2c20ad7d5b.js" async=""></script></body></html>